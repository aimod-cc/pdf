# 认证中心接入指南

本文档面向需要接入 Auth Center 统一认证的产品开发者。

## 概述

Auth Center 是一个 SSO（单点登录）认证中心，为所有产品提供统一的用户注册、登录服务。

- 认证中心地址：`https://auth.aimod.cc`
- Cookie 域名：`.aimod.cc`（所有子域名共享登录状态）

## 接入前准备

1. 联系管理员将你的产品域名添加到「受信任域名」列表
2. 确保你的产品部署在 `*.aimod.cc` 子域名下

## 接入方式

### 方式一：跳转登录（推荐）

最简单的接入方式，用户点击登录后跳转到认证中心完成登录，然后跳回你的产品。

```javascript
// 跳转到登录页
function goLogin() {
  const returnUrl = encodeURIComponent(window.location.href);
  window.location.href = `https://auth.aimod.cc/login?redirect=${returnUrl}`;
}
```

登录成功后，认证中心会在 `.aimod.cc` 域下设置 `auth_token` Cookie，你的产品可以直接读取。

### 方式二：API 调用

如果你需要在自己的产品内实现登录表单，可以直接调用认证中心 API。

---

## API 接口

### 响应格式

所有接口返回统一的 JSON 格式：

```json
// 成功
{
  "success": true,
  "data": { ... }
}

// 失败
{
  "success": false,
  "code": "ERROR_CODE",
  "error": "错误描述"
}
```

**重要：前端应使用 `code` 字段判断错误类型，而非 `error` 文案。**

---

### 用户注册

```http
POST https://auth.aimod.cc/api/auth/register
Content-Type: application/json

{
  "username": "myaccount",
  "password": "Pass123",
  "name": "用户昵称",
  "email": "user@example.com"
}
```

| 参数 | 必填 | 说明 |
|------|------|------|
| username | 是 | 账号，4-20位字母数字下划线，必须以字母开头 |
| password | 是 | 密码，至少6位，需包含字母和数字 |
| name | 否 | 昵称 |
| email | 否 | 邮箱（可用于登录） |

### 用户登录

支持使用账号或邮箱登录。

```http
POST https://auth.aimod.cc/api/auth/login
Content-Type: application/json

{
  "account": "myaccount",
  "password": "Pass123"
}
```

| 参数 | 必填 | 说明 |
|------|------|------|
| account | 是 | 账号或邮箱 |
| password | 是 | 密码 |

### 修改密码

```http
POST https://auth.aimod.cc/api/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "oldPassword": "OldPass123",
  "newPassword": "NewPass456"
}
```

修改密码后会返回新 Token，旧 Token 将失效（包括其他设备）。

### 修改用户资料

```http
POST https://auth.aimod.cc/api/auth/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "新昵称",
  "email": "newemail@example.com",
  "avatar": "https://example.com/avatar.jpg"
}
```

所有参数都是可选的，只会更新传入的字段。

### 验证登录状态

```http
GET https://auth.aimod.cc/api/auth/status
Cookie: auth_token=xxx
```

### 验证 Token（服务端调用）

```http
GET https://auth.aimod.cc/api/auth/verify
Authorization: Bearer <token>
```

### 验证跳转 URL

```http
GET https://auth.aimod.cc/api/auth/validate-redirect?url=https://app.aimod.cc/callback
```

### 登出

```http
POST https://auth.aimod.cc/api/auth/logout
```

---

## 错误码

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或 Token 无效 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器错误 |

### 业务错误码

| code | HTTP | 说明 | 建议前端行为 |
|------|------|------|-------------|
| `INVALID_PARAM` | 400 | 缺少必填参数 | 提示用户填写完整 |
| `INVALID_USERNAME_FORMAT` | 400 | 账号格式错误 | 提示格式要求 |
| `WEAK_PASSWORD` | 400 | 密码强度不足 | 提示密码要求 |
| `REGISTER_DISABLED` | 403 | 注册功能已关闭 | 提示联系管理员 |
| `USERNAME_EXISTS` | 400 | 账号已被注册 | 提示直接登录 |
| `EMAIL_EXISTS` | 400 | 邮箱已被使用 | 提示更换邮箱 |
| `LOGIN_FAILED` | 401 | 账号或密码错误 | 允许重试 |
| `LOGIN_LOCKED` | 429 | 登录失败次数过多 | 显示倒计时，禁用按钮 |
| `ACCOUNT_BANNED` | 403 | 账号已被封禁 | 提示联系管理员 |
| `NOT_ADMIN` | 403 | 无管理员权限 | 提示无权访问 |
| `NOT_LOGGED_IN` | 401 | 未登录 | 跳转登录页 |
| `TOKEN_INVALID` | 401 | Token 格式错误或已过期 | 跳转登录页 |
| `TOKEN_REVOKED` | 401 | 登录已失效（被强制下线） | 弹窗提示，跳转登录页 |
| `USER_NOT_FOUND` | 404 | 用户不存在 | 跳转登录页 |
| `WRONG_PASSWORD` | 400 | 旧密码错误 | 提示重新输入 |
| `INVALID_URL` | 400 | 无效的 URL | 提示 URL 格式错误 |
| `SERVER_ERROR` | 500 | 服务器错误 | 提示稍后重试 |

### 前端错误处理示例

```typescript
async function handleLogin(account: string, password: string) {
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ account, password }),
    credentials: 'include',
  });
  
  const data = await res.json();
  
  if (data.success) {
    // 登录成功
    return data.data.user;
  }
  
  // 根据错误码处理
  switch (data.code) {
    case 'LOGIN_FAILED':
      showError('账号或密码错误，请重试');
      break;
    case 'LOGIN_LOCKED':
      showError(data.error); // 使用后端返回的带时间的提示
      disableLoginButton();
      break;
    case 'ACCOUNT_BANNED':
      showError('您的账号已被封禁，请联系管理员');
      break;
    default:
      showError(data.error);
  }
}
```

---

## Token 说明

- Token 格式：JWT
- 有效期：7 天
- 存储位置：Cookie（`auth_token`），域名 `.aimod.cc`

### JWT Payload 结构

```json
{
  "userId": 1,
  "username": "myaccount",
  "email": "user@example.com",
  "name": "用户昵称",
  "tokenVersion": 0,
  "exp": 1234567890
}
```

### 关于 TokenVersion

当用户修改密码或被管理员强制下线时，数据库中的 `token_version` 会自增。旧 Token 即使未过期，因其 payload 中的 `tokenVersion` 小于数据库当前值，也会被视为失效。

这是一种轻量级的 Token 撤销机制，无需维护黑名单。

### Token 失效场景

| 场景 | 返回错误码 |
|------|-----------|
| Token 过期（7天） | `TOKEN_INVALID` |
| 用户修改密码 | `TOKEN_REVOKED` |
| 管理员强制下线 | `TOKEN_REVOKED` |
| 管理员封禁账号 | `ACCOUNT_BANNED` |

---

## 前端集成示例

### React Hook

```tsx
import { useState, useEffect } from 'react';

interface User {
  id: number;
  username: string;
  email?: string;
  name?: string;
  avatar?: string;
}

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('https://auth.aimod.cc/api/auth/status', { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.data.loggedIn) {
          setUser(data.data.user);
        }
      })
      .finally(() => setLoading(false));
  }, []);

  const login = () => {
    const returnUrl = encodeURIComponent(window.location.href);
    window.location.href = `https://auth.aimod.cc/login?redirect=${returnUrl}`;
  };

  const logout = async () => {
    await fetch('https://auth.aimod.cc/api/auth/logout', { 
      method: 'POST',
      credentials: 'include' 
    });
    setUser(null);
    window.location.reload();
  };

  return { user, loading, login, logout };
}
```

---

## 安全说明

1. **登录失败保护**：连续失败5次后锁定15分钟
2. **密码强度要求**：至少6位，必须包含字母和数字
3. **账号格式要求**：4-20位字母数字下划线，必须以字母开头
4. **强制下线机制**：修改密码或被管理员操作后，所有已登录设备会被强制下线
5. **受信任域名**：登录跳转只允许跳转到白名单中的域名

---

## 注意事项

1. 所有 API 请求需要带上 `credentials: 'include'` 以携带 Cookie
2. 跨域请求已配置 CORS，支持 `*.aimod.cc` 域名
3. 前端应使用 `code` 字段判断错误类型，不要依赖 `error` 文案
4. 如需在服务端验证用户身份，使用 `/api/auth/verify` 接口

## 联系方式

如有问题，请联系认证中心管理员。
